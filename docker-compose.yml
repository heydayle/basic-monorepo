x-vite-env: &vite-env
  VITE_API_BASE_URL: ${VITE_API_BASE_URL}

x-pnpm-workspace: &pnpm-workspace
  build:
    context: .
    dockerfile: frontend/Dockerfile.dev  # Dockerfile dev dùng cho toàn repo
  working_dir: /workspace                # root của monorepo
  volumes:
    - .:/workspace
    - workspace_node_modules:/workspace/node_modules

services:
  # Cài dependency cho toàn workspace
  packages-install:
    <<: *pnpm-workspace
    command: pnpm install

  # (Nếu bạn vẫn muốn service riêng cho "packages" – ví dụ storybook)
  frontend-packages:
    <<: *pnpm-workspace
    working_dir: /workspace/packages     # nếu cần chạy gì trong packages
    command: pnpm --filter packages dev        # ví dụ
    profiles:
      - packages

  # App frontend chính
  frontend:
    <<: *pnpm-workspace
    working_dir: /workspace/frontend
    ports:
      - "3000:3000"
    env_file:
      - .env
      - frontend/.env
    environment:
      <<: *vite-env
    depends_on:
      - packages-install
    command: pnpm --filter frontend dev

volumes:
  workspace_node_modules: {}
