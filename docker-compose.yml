x-vite-env: &vite-env
  VITE_API_BASE_URL: ${VITE_API_BASE_URL}

x-workspace-service: &workspace-service
  build:
    context: .
    dockerfile: docker/Dockerfile.dev
  working_dir: /workspace
  volumes:
    - .:/workspace
    - workspace_node_modules:/workspace/node_modules
    - pnpm_store:/workspace/.pnpm-store

services:
  # Install dependencies once for the whole monorepo
  packages-install:
    <<: *workspace-service
    command: pnpm install

  # (Optional) workspace-level commands for packages
  frontend-packages:
    <<: *workspace-service
    working_dir: /workspace/packages
    command: pnpm --filter packages dev
    profiles:
      - packages

  # Main frontend app
  frontend:
    <<: *workspace-service
    working_dir: /workspace/frontend
    ports:
      - "3000:3000"
    env_file:
      - .env
      - frontend/.env
    environment:
      <<: *vite-env
    depends_on:
      - packages-install
    command: pnpm --filter frontend dev

volumes:
  workspace_node_modules: {}
  pnpm_store: {}
